<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>深入Vue响应式原理 | Lawson&#39;s Blog | 认清现实，你只是看起来很努力。</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Vue">
    <meta name="description" content="如何追踪变化？当你把一个普通的 JavaScript 对象传入 Vue 实例作为 data 选项，Vue 将遍历此对象所有的 property，并使用 Object.defineProperty 把这些 property 全部转为 getter&#x2F;setter。数据代理的另一个说法是数据劫持，当我们在访问或者修改对象的某个属性时，数据劫持可以拦截这个行为并进行额外的操作或者修改返回的结果。我们知道V">
<meta property="og:type" content="article">
<meta property="og:title" content="深入Vue响应式原理">
<meta property="og:url" content="http://lawsan.xyz/2020/07/25/%E6%B7%B1%E5%85%A5Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="Lawson&#39;s Blog">
<meta property="og:description" content="如何追踪变化？当你把一个普通的 JavaScript 对象传入 Vue 实例作为 data 选项，Vue 将遍历此对象所有的 property，并使用 Object.defineProperty 把这些 property 全部转为 getter&#x2F;setter。数据代理的另一个说法是数据劫持，当我们在访问或者修改对象的某个属性时，数据劫持可以拦截这个行为并进行额外的操作或者修改返回的结果。我们知道V">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/2020/July/25/Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="article:published_time" content="2020-07-25T08:55:08.000Z">
<meta property="article:modified_time" content="2020-07-26T03:01:23.363Z">
<meta property="article:author" content="Lawson">
<meta property="article:tag" content="Vue">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/2020/July/25/Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
    
        <link rel="alternate" type="application/atom+xml" title="Lawson&#39;s Blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/assets/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/assets/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/assets/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Lawson</h5>
          <a href="mailto:2292100085@qq.com" title="2292100085@qq.com" class="mail">2292100085@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/ChuanV" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://blog.csdn.net/qq_42335214" target="_blank" >
                <i class="icon icon-lg icon-send"></i>
                CSDN
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-exclamation-circle"></i>
                关于
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">深入Vue响应式原理</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">深入Vue响应式原理</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-07-25T08:55:08.000Z" itemprop="datePublished" class="page-time">
  2020-07-25
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#如何追踪变化？"><span class="post-toc-number">1.</span> <span class="post-toc-text">如何追踪变化？</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Object-defineProperty"><span class="post-toc-number">2.</span> <span class="post-toc-text">Object.defineProperty</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Proxy"><span class="post-toc-number">3.</span> <span class="post-toc-text">Proxy</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#依赖收集"><span class="post-toc-number">4.</span> <span class="post-toc-text">依赖收集</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#为什么要收集依赖？"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">为什么要收集依赖？</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#订阅者-Dep"><span class="post-toc-number">5.</span> <span class="post-toc-text">订阅者 Dep</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#观察者-Watcher"><span class="post-toc-number">6.</span> <span class="post-toc-text">观察者 Watcher</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#收集依赖"><span class="post-toc-number">7.</span> <span class="post-toc-text">收集依赖</span></a></li></ol>
        </nav>
    </aside>


<article id="post-深入Vue响应式原理"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">深入Vue响应式原理</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-07-25 16:55:08" datetime="2020-07-25T08:55:08.000Z"  itemprop="datePublished">2020-07-25</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h3 id="如何追踪变化？"><a href="#如何追踪变化？" class="headerlink" title="如何追踪变化？"></a>如何追踪变化？</h3><p>当你把一个普通的 JavaScript 对象传入 Vue 实例作为 data 选项，Vue 将遍历此对象所有的 property，并使用 <code>Object.defineProperty</code> 把这些 property 全部转为 <code>getter/setter</code>。<br>数据代理的另一个说法是数据劫持，当我们在访问或者修改对象的某个属性时，数据劫持可以拦截这个行为并进行额外的操作或者修改返回的结果。我们知道Vue响应式系统的核心就是数据代理，代理使得数据在访问时进行依赖收集，在修改更新时对依赖进行更新，这是响应式系统的核心思路。</p>
<h3 id="Object-defineProperty"><a href="#Object-defineProperty" class="headerlink" title="Object.defineProperty"></a>Object.defineProperty</h3><p><code>Object.defineProperty()</code>方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性， 并返回这个对象。<br>基本用法：<code>Object.defineProperty(obj, prop, descriptor)</code><br><code>Object.defineProperty()</code>可以用来精确添加或修改对象的属性，只需要在descriptor对象中将属性特性描述清楚，descriptor的属性描述符有两种形式，一种是数据描述符，另一种是存取描述符，我们分别看看各自的特点。<br>数据描述符，它拥有四个属性配置</p>
<ul>
<li><code>configurable</code>：数据是否可删除，可配置</li>
<li><code>enumerable</code>：属性是否可枚举</li>
<li><code>value</code>：属性值,默认为undefined</li>
<li><code>writable</code>：属性是否可读写<br>存取描述符，它同样拥有四个属性选项</li>
<li><code>configurable</code>：数据是否可删除，可配置</li>
<li><code>enumerable</code>：属性是否可枚举</li>
<li><code>get</code>:一个给属性提供 getter 的方法，如果没有 getter 则为 undefined。</li>
<li><code>set</code>:一个给属性提供 setter 的方法，如果没有 setter 则为 undefined。</li>
<li><em>需要注意的是: 数据描述符的<code>value</code>，<code>writable</code> 和 存取描述符中的<code>get</code>, <code>set</code>属性不能同时存在，否则会抛出异常。*</em><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!data || <span class="keyword">typeof</span> data !== <span class="string">'object'</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>)</span>&#123;</span><br><span class="line">		defineReactive(data,key,data[key])</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">data,key,val</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">Object</span>.defineProperty(data,key,&#123;</span><br><span class="line">		enumerable:<span class="literal">true</span>,</span><br><span class="line">		configurable:<span class="literal">false</span>,</span><br><span class="line">		<span class="keyword">get</span>()&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">'获取值'</span>)</span><br><span class="line">			<span class="keyword">return</span> val</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="keyword">set</span>(newVal)&#123;</span><br><span class="line">			<span class="keyword">if</span>(val === newVal) <span class="keyword">return</span></span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">'监听到值变化了'</span>,val,<span class="string">'--&gt;'</span>,newVal)</span><br><span class="line">			val = newVal</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">name</span>:<span class="string">'lisi'</span>&#125;</span><br><span class="line">observe(arr)</span><br><span class="line">observe(obj)</span><br><span class="line">obj.age = <span class="number">18</span> <span class="comment">//拦截不到</span></span><br><span class="line">obj.name <span class="comment">//获取值</span></span><br><span class="line">obj.name = <span class="string">'programmer'</span> <span class="comment">//监听到值变化了 lisi --&gt;programmer</span></span><br><span class="line">arr[<span class="number">1</span>] <span class="comment">//获取值</span></span><br><span class="line">arr[<span class="number">2</span>] = <span class="number">8</span> <span class="comment">//监听到值变化了 3 --&gt;8</span></span><br><span class="line">arr[<span class="number">4</span>] = <span class="number">5</span> <span class="comment">//拦截不到</span></span><br></pre></td></tr></table></figure>
然而<code>Object.defineProperty</code>是有缺陷的，比如添加属性是监听不到对象的添加和删除或者数组的变化是无法拦截的。</li>
</ul>
<h3 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h3><p>为了解决像数组这类无法进行数据拦截，以及深层次的嵌套问题，es6引入了<code>Proxy</code>的概念，它是真正在语言层面对数据拦截的定义。和<code>Object.defineProperty</code>一样，<code>Proxy</code>可以修改某些操作的默认行为，但是不同的是，<code>Proxy</code><strong>针对目标对象会创建一个新的实例对象，并将目标对象代理到新的实例对象上</strong>，。 本质的区别是后者会创建一个新的对象对原对象做代理，外界对原对象的访问，都必须先通过这层代理进行拦截处理。而拦截的结果是我们只要通过操作新的实例对象就能间接的操作真正的目标对象了。针对Proxy，下面是基础的写法:<br>语法：<code>const p = new Proxy(target, handler)</code></p>
<ul>
<li><code>target</code>要使用 Proxy 包装的目标对象（可以是任何类型的对象，包括原生数组，函数，甚至另一个代理）。</li>
<li><code>handler</code>一个通常以函数作为属性的对象，各属性中的函数分别定义了在执行各种操作时代理 p 的行为。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">b</span>:<span class="number">18</span>&#125;</span><br><span class="line"><span class="keyword">var</span> nobj = <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span><br><span class="line">    <span class="keyword">get</span>(target, key, receiver) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'获取值'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, key, receiver)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span>(target, key, value, receiver) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'设置值'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Reflect</span>.set(target, key, value, receiver)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">nobj.a = <span class="string">'代理'</span></span><br><span class="line"><span class="built_in">console</span>.log(obj) <span class="comment">//设置值 &#123;b:18,a: "代理"&#125;</span></span><br></pre></td></tr></table></figure>
<code>Proxy</code>能监听数组的变化，<code>添加</code>，<code>删除</code>，<code>修改</code>等。</li>
</ul>
<h3 id="依赖收集"><a href="#依赖收集" class="headerlink" title="依赖收集"></a>依赖收集</h3><h4 id="为什么要收集依赖？"><a href="#为什么要收集依赖？" class="headerlink" title="为什么要收集依赖？"></a>为什么要收集依赖？</h4><p>举个例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>该模板中使用了数据name，所以它发生变化时，要向使用了它的地方发送通知。总结一句话就是<strong>在getter中收集依赖，在setter中触发依赖</strong></p>
<h3 id="订阅者-Dep"><a href="#订阅者-Dep" class="headerlink" title="订阅者 Dep"></a>订阅者 Dep</h3><p>我们把依赖收集的代码封装成一个Dep类，它帮助我们管理依赖。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span> () &#123;</span><br><span class="line">        <span class="comment">/* 用来存放Watcher对象的数组 */</span></span><br><span class="line">        <span class="keyword">this</span>.subs = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 在subs中添加一个Watcher对象 */</span></span><br><span class="line">    addSub (sub) &#123;</span><br><span class="line">        <span class="keyword">this</span>.subs.push(sub);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 通知所有Watcher对象更新视图 */</span></span><br><span class="line">    notify () &#123;</span><br><span class="line">        <span class="keyword">this</span>.subs.forEach(<span class="function">(<span class="params">sub</span>) =&gt;</span> &#123;</span><br><span class="line">            sub.update();</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用 <code>addSub</code> 方法可以在目前的 Dep 对象中增加一个 Watcher 的订阅操作；<br>用 <code>notify</code> 方法通知目前 Dep 对象的 subs 中的所有 Watcher 对象触发更新操作。</p>
<h3 id="观察者-Watcher"><a href="#观察者-Watcher" class="headerlink" title="观察者 Watcher"></a>观察者 Watcher</h3><p>当属性发生变化后，我们要通知用到数据的地方，而使用这个数据的地方有很多，而且类型还不一样，既有可能是模板，也有可能是用户写的一个watch,这时需要抽象出一个能集中处理这些情况的类。然后，我们在依赖收集阶段只收集这个封装好的类的实例进来，通知也只通知它一个，再由它负责通知其他地方。<br>依赖收集的目的是将观察者 Watcher 对象存放到当前闭包中的订阅者 Dep 的 subs 中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(obj, key, cb) &#123;</span><br><span class="line">    <span class="comment">// 将 Dep.target 指向自己</span></span><br><span class="line">    <span class="comment">// 然后触发属性的 getter 添加监听</span></span><br><span class="line">    <span class="comment">// 最后将 Dep.target 置空</span></span><br><span class="line">    Dep.target = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">this</span>.cb = cb</span><br><span class="line">    <span class="keyword">this</span>.obj = obj</span><br><span class="line">    <span class="keyword">this</span>.key = key</span><br><span class="line">    <span class="keyword">this</span>.value = obj[key]</span><br><span class="line">    Dep.target = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  update() &#123;</span><br><span class="line">    <span class="comment">// 获得新值</span></span><br><span class="line">    <span class="keyword">this</span>.value = <span class="keyword">this</span>.obj[<span class="keyword">this</span>.key]</span><br><span class="line">   <span class="comment">// 我们定义一个 cb 函数，这个函数用来模拟视图更新，调用它即代表更新视图</span></span><br><span class="line">    <span class="keyword">this</span>.cb(<span class="keyword">this</span>.value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上就是 Watcher 的简单实现，在执行构造函数的时候将 Dep.target 指向自身，从而使得收集到了对应的 Watcher，在派发更新的时候取出对应的 Watcher ,然后执行 update 函数。</p>
<h3 id="收集依赖"><a href="#收集依赖" class="headerlink" title="收集依赖"></a>收集依赖</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 判断类型</span></span><br><span class="line">  <span class="keyword">if</span> (!obj || <span class="keyword">typeof</span> obj !== <span class="string">'object'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Object</span>.keys(obj).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    defineReactive(obj, key, obj[key])</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span> (<span class="params">obj, key, value</span>) </span>&#123;</span><br><span class="line">    observe(value)  <span class="comment">// 递归子属性</span></span><br><span class="line">    <span class="keyword">let</span> dp = <span class="keyword">new</span> Dep() <span class="comment">//新增</span></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">      enumerable: <span class="literal">true</span>, <span class="comment">//可枚举（可以遍历）</span></span><br><span class="line">      configurable: <span class="literal">true</span>, <span class="comment">//可配置（比如可以删除）</span></span><br><span class="line">      <span class="keyword">get</span>: function reactiveGetter () &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'get'</span>, value) <span class="comment">// 监听</span></span><br><span class="line">     <span class="comment">// 将 Watcher 添加到订阅</span></span><br><span class="line">       <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">         dp.addSub(Dep.target) <span class="comment">// 新增</span></span><br><span class="line">       &#125;</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="keyword">set</span>: function reactiveSetter (newVal) &#123;</span><br><span class="line">        observe(newVal) <span class="comment">//如果赋值是一个对象，也要递归子属性</span></span><br><span class="line">        <span class="keyword">if</span> (newVal !== value) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'set'</span>, newVal) <span class="comment">// 监听</span></span><br><span class="line">          render()</span><br><span class="line">          value = newVal</span><br><span class="line">     <span class="comment">// 执行 watcher 的 update 方法</span></span><br><span class="line">          dp.notify() <span class="comment">//通知更新</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">        <span class="keyword">this</span>._data = options.data;</span><br><span class="line">        observer(<span class="keyword">this</span>._data);</span><br><span class="line">        <span class="comment">/* 新建一个Watcher观察者对象，这时候Dep.target会指向这个Watcher对象 */</span></span><br><span class="line">        <span class="keyword">new</span> Watcher();</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'模拟视图渲染'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相关流程如下图</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/2020/July/25/Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<p>在 new Vue() 后， Vue 会调用<code>_init</code> 函数进行初始化，也就是init 过程，在 这个过程Data通过<code>Observer</code>转换成了<code>getter/setter</code>的形式，来对数据追踪变化，当被设置的对象被读取的时候会执行getter 函数，而在当被赋值的时候会执行 setter函数。<br>当render function 执行的时候，因为会读取所需对象的值，所以会触发getter函数从而将Watcher添加到依赖中进行依赖收集。<br>在修改对象的值的时候，会触发对应的setter， setter通知之前依赖收集得到的 Dep 中的每一个 Watcher，告诉它们自己的值改变了，需要重新渲染视图。这时候这些 Watcher就会开始调用 update 来更新视图。</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2020-07-26T03:01:23.363Z" itemprop="dateUpdated">2020-07-26 11:01:23</time>
</span><br>


        
        版权声明：本文为博主原创文章，遵循<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" >CC 4.0 BY-SA</a>版权协议，转载请附上原文出处链接。
        
    </div>
    
    <footer>
        <a href="http://lawsan.xyz">
            <img src="https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/assets/avatar.jpg" alt="Lawson">
            Lawson
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue/" rel="tag">Vue</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://lawsan.xyz/2020/07/25/%E6%B7%B1%E5%85%A5Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/&title=《深入Vue响应式原理》 — Lawson's Blog&pic=https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/assets/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://lawsan.xyz/2020/07/25/%E6%B7%B1%E5%85%A5Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/&title=《深入Vue响应式原理》 — Lawson's Blog&source=阿穿的博客。做人最重要的是开心。" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://lawsan.xyz/2020/07/25/%E6%B7%B1%E5%85%A5Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《深入Vue响应式原理》 — Lawson's Blog&url=http://lawsan.xyz/2020/07/25/%E6%B7%B1%E5%85%A5Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/&via=http://lawsan.xyz" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://lawsan.xyz/2020/07/25/%E6%B7%B1%E5%85%A5Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2020/07/23/%E5%85%B3%E4%BA%8EHTML5%E4%B8%AD%E6%96%B0%E5%A2%9E%E7%9A%84%E7%89%B9%E6%80%A7/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">关于HTML5中新增的特性</h4>
      </a>
    </div>
  
</nav>



    

















<section class="comments" id="comments">
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
        var id = location.pathname
        if (location.pathname.length > 50) {
          id = location.pathname.replace(/\/\d+\/\d+\/\d+\//, '').replace('/', '').substring(0, 50)
        }
        const gitalk = new Gitalk({
          clientID: '60476e5f2147b66e183a',
          clientSecret: '62d6d1e9df0f3f402e64a84793b11b781331015e',
          repo: 'blog_comments',
          owner: 'ChuanV',
          admin: ['ChuanV'],
          id: id,      // Ensure uniqueness and length less than 50
          title: document.title.split('|')[0],
          distractionFreeMode: false  // Facebook-like distraction free mode
        })

        gitalk.render('gitalk-container')
    </script>
</section>




</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/assets/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/assets/wechat.jpg" data-alipay="https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/assets/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Lawson &copy; 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://lawsan.xyz/2020/07/25/%E6%B7%B1%E5%85%A5Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/&title=《深入Vue响应式原理》 — Lawson's Blog&pic=https://happychuan-pic.oss-cn-shenzhen.aliyuncs.com/assets/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://lawsan.xyz/2020/07/25/%E6%B7%B1%E5%85%A5Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/&title=《深入Vue响应式原理》 — Lawson's Blog&source=阿穿的博客。做人最重要的是开心。" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://lawsan.xyz/2020/07/25/%E6%B7%B1%E5%85%A5Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《深入Vue响应式原理》 — Lawson's Blog&url=http://lawsan.xyz/2020/07/25/%E6%B7%B1%E5%85%A5Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/&via=http://lawsan.xyz" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://lawsan.xyz/2020/07/25/%E6%B7%B1%E5%85%A5Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADOElEQVR42u3aQXLjMAwEwPz/0841VYm1M6C8JVGtk8t2JDZ9QIDh11d8vX5cx58m3/z9+tz7nHZhY2Nj34T9OrzePWa2rHd/lazh3R2O1/Z2ndjY2NjbsWfFJikhM2qCyVeCjY2NjX1chFa+eVwI203HxsbGxj6+ddIYHJeoFr/SlmBjY2M/jZ03A7M5fB4JtIXq47M0bGxs7MuzV5Z+tdcfybexsbGxL8x+lVfSlsyGU+vPLe6GjY2NvRF7dmQnB+SDqpW/aodc2NjY2Dux81HOeij7iffzcAIbGxv7CexkNJNswfHi8kaiDTCKA0PY2NjYm7KTAjA7apkPofL15IExNjY29t7s5Hb5UZtkCJVHBflW5pFDsYvY2NjYt2LnjUf7T39eTvK7zdqYpQM92NjY2JdnnzasiTfuFVztz9AeG8XGxsbeiZ0fncyP77QBbd6izKKCaFewsbGxb8heKVory2q38tzWCBsbG3sndluQEnxeDtu7zSKHomJjY2Nj35adH5dJAMn7bSDR/gzY2NjYz2G3R21mke16YLC+KW/zEGxsbOyN2G1hOHfLZpFDEej+fB8bGxv7Mey8j2kD17xFyQPdvChiY2Nj782eFaRh1Bo3IbPvY2NjYz+Bncer+dB/5T75UCkvhNjY2Nh7sz8R7rYLyiPntnX5r5k2NjY29gXY+fg+/zRpac7ajuJZ2NjY2BuxV8Y0yYPbO7eBRFvw/vGbY2NjY9+WHR1zCRbUDqFmwe0sMI72DxsbG/uG7Hw037LztiQvUbMy9sen2NjY2Bux26M2+VLahmTl8E3bumBjY2Pvx25D1uMRUjtsakOFdjuikomNjY19c3bekOTF6axEdb1oDVMRbGxs7NuyZ4dm8jqZb2JeqIZhMDY2NvYW7Fd5zdqSpfy5JEXtDTY2NvZG7PYxydioHS2tFL/ZoSJsbGzs/dhnBbH5EH824p9FF8N4ABsbG/uG7HoWVZaWle8Pq+7xpmNjY2NjlyUkiXVnY6NkvPXHU7CxsbEfzJ4dylk5GLRS0k4rYNjY2NiXZ68Md9rYIC85+dbXTQ42Njb2RuzZEZmc125H+/SVEBobGxv75uxv0kS791MbCAYAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


lazyScripts.push('//s95.cnzz.com/z_stat.php?id=1279039707&web_id=1279039707')

</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'Lawson's Blog';
            clearTimeout(titleTime);
        } else {
            document.title = 'Lawson's Blog';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
